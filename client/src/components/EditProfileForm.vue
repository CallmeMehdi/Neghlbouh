<template>
  <v-hover open-delay="200" v-slot:default="{ hover }">
    <v-card
      :elevation="hover ? 16 : 2"
      class="mx-auto cardc"
      dir="rtl"
      max-width="700"
    >
      <br />
      <div>
        <v-form class="form" ref="form" method="put">
          <v-row>
            <div class="col-md-6">
              <v-label><h3>الإسم و اللقب</h3></v-label>
              <v-text-field
                :placeholder="user.name"
                :rules="nameRules"
                color="#d41b45"
                v-model="name"
              ></v-text-field>
            </div>
            <div class="col-md-6">
              <v-label><h3>الإسم و اللقب</h3></v-label>
              <v-text-field
                :rules="nameRules"
                color="#d41b45"
                v-model="cin"
              ></v-text-field>
            </div>
          </v-row>
          <v-row>
            <div class="col-md-6">
              <v-label><h3>مكان السكن</h3></v-label>
              <v-select :items="cities" v-model="city"></v-select>
            </div>
            <div class="col-md-6">
              <v-label><h3>المنطقة</h3></v-label>
              <v-select :items="items" v-model="area"></v-select>
            </div>
          </v-row>
          <v-row>
            <div class="col-md-6">
              <v-label><h3>البريد الالكتروني</h3></v-label>
              <v-text-field
                :placeholder="user.email"
                :rules="emailRules"
                color="#d41b45"
                v-model="email"
              ></v-text-field>
            </div>
            <div class="col-md-6">
              <v-label><h3>رقم الهاتف</h3></v-label>
              <v-text-field
                :placeholder="user.phone"
                :rules="phoneRules"
                color="#d41b45"
                v-model="phone"
              ></v-text-field>
            </div>
          </v-row>
          <v-btn
            @click="updatePass"
            class="title"
            color="#d41b45"
            dark
            height="25px"
            rounded
          >
            تغيير كلمة السر
          </v-btn>
          <div class="row" v-if="isClicked">
            <div class="col-md-6">
              <v-label><h3>كلمة السر القديمة</h3></v-label>
              <v-text-field
                :rules="rules"
                color="red"
                type="password"
                v-model="oldPassword"
              ></v-text-field>
            </div>
            <div class="col-md-6">
              <v-label><h3>كلمة السر الجديدة</h3></v-label>
              <v-text-field
                :rules="rules"
                color="red"
                type="password"
                v-model="newPassword"
              ></v-text-field>
            </div>
          </div>
        </v-form>
        <br />
        <div class="text-center">
          <v-btn
            :disabled="button"
            :loading="loading"
            @click="validate"
            class="title"
            color="#d41b45"
            dark
            rounded
            style="margin-top: 0px;"
          >
            تعديل حسابي
          </v-btn>
        </div>
        <div class="mt-5" v-if="done">تم تعديل المعطيات بنجاح</div>
        <div class="clearfix"></div>
      </div>
    </v-card>
  </v-hover>
</template>
<script>
import authController from "../services/AuthenticationService";

export default {
  name: "EditProfileForm",
  props: {
    isClicked: {
      Boolean,
      default: false
    },
    user: {
      name: "",
      city: "",
      area: "",
      phone: "",
      email: "",
      cin: ""
    }
  },
  data() {
    return {
      loading: false,
      done: false,
      valid: true,
      newPassword: "",
      oldPassword: "",
      name: this.user.name,
      city: this.user.city,
      cin: this.user.cin,
      phone: this.user.phone,
      email: this.user.email,
      cities: [
        "أريانة",
        "باجة",
        "بنزرت",
        "بن عروس",
        "تطاوين",
        "توزر",
        "تونس",
        "جندوبة",
        "زغوان",
        "سليانة",
        "سوسة",
        "سيدي بوزيد",
        "صفاقس",
        "قابس",
        "قبلي",
        "القصرين",
        "قفصة",
        "القيروان",
        "الكاف",
        "مدنين",
        "المنستير",
        "منوبة",
        "المهدية",
        "نابل"
      ],
      items: [
        "ساقية الزيت",
        "ساقية الدائر",
        "العين صفاقس",
        "قرمدة",
        "طينة",
        "الشيحية",
        "المحرس",
        "قرقنة",
        "الصخيرة",
        "عقارب",
        "الحنشة",
        "جبنيانة",
        "بئر علي صفاقس",
        "الغريبة",
        "العامرة",
        "العوابد - الخزانات",
        "الناظور",
        "الحاجب",
        "حزق",
        "الأعشاش",
        "النصر"
      ],
      phoneRules: [
        v => (!isNaN(parseFloat(v)) && !isNaN(v - 0)) || "يجب أن يكون رقم"
      ],
      nameRules: [
        v => (v && v.length <= 30) || "Name must be less than 30 characters"
      ],
      emailRules: [v => /.+@.+\..+/.test(v) || "E-mail must be valid"]
    };
  },
  computed: {
    button() {
      if (
        this.name !== this.user.name ||
        this.city !== this.user.city ||
        this.cin !== this.user.cin ||
        this.phone !== this.user.phone ||
        this.area !== this.user.area ||
        this.email !== this.user.email ||
        (this.oldPassword !== "" && this.newPassword != "")
      ) {
        // eslint-disable-next-line vue/no-side-effects-in-computed-properties
        this.valid = true;
        return false;
      } else {
        return true;
      }
    }
  },
  methods: {
    updatePass() {
      if (!this.isClicked) {
        this.isClicked = true;
      } else {
        this.isClicked = false;
      }
    },
    async validate() {
      this.$refs.form.validate();
      if (this.valid) {
        this.loading = true;
        try {
          let resp = await authController.update({
            oldPassword: this.oldPassword,
            newPassword: this.newPassword,
            name: this.name,
            email: this.email,
            city: this.city,
            cin: this.cin,
            area: this.area,
            phone: this.phone
          });
          this.loading = false;
          this.done = true;
          console.log(resp);
        } catch (e) {
          this.loading = false;
          console.log(e.response.data);
          this.error = e.response.data.err;
        }
      } else {
        //to implement notification v-if here
        console.log("validation failed");
      }
    }
  }
};
</script>
<style>
.form {
  padding-right: 20px;
  padding-left: 20px;
}

.cardc {
  padding-bottom: 20px;
  height: 520px;
}

h3 {
  color: #d41b45;
  height: 3px;
  font-family: Cairo;
}
</style>
